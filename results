
# ------------------------------------------------------------
# Country-level prediction table RF
# ------------------------------------------------------------
def country_prediction_table(df, y_true_col, y_pred_col):
    """
    Country-level mean table: y_true vs y_pred.
    """
    return (
        df
        .groupby(["Country", "ISO3"], as_index=False)
        .agg(
            y_true=(y_true_col, "mean"),
            y_pred=(y_pred_col, "mean")
        )
    )


# ------------------------------------------------------------
# RF vs GB comparison table
# ------------------------------------------------------------
def rf_gb_comparison_table(df):
    """
    Table with country-level mean predictions:
    y_true, y_pred_rf, y_pred_gb
    """
    return (
        df
        .groupby(["Country", "ISO3"], as_index=False)
        .agg(
            y_true=("co2_per_capita", "mean"),
            y_pred_rf=("co2_pred_rf", "mean"),
            y_pred_gb=("co2_pred_gb", "mean")
        )
    )


# ------------------------------------------------------------
# K-Means cluster table
# ------------------------------------------------------------
def kmeans_cluster_table(df_country):
    """
    Final clustering table: Country, co2_mean, cluster, group label.
    """
    return df_country[[
        "Country",
        "co2_mean",
        "cluster_mode",
        "co2_group"
    ]].copy()


# ============================================================
# ======================= PLOTS ===============================
# ============================================================

# ------------------------------------------------------------
# PCA scatter – all observations
# ------------------------------------------------------------
def plot_pca_scatter(df_pca):
    plt.figure(figsize=(10, 7))
    plt.scatter(df_pca["PC1"], df_pca["PC2"], alpha=0.6)
    plt.xlabel("PC1")
    plt.ylabel("PC2")
    plt.title("PCA (standardized) – all observations")
    plt.grid(True)
    plt.show()


# ------------------------------------------------------------
# PCA scatter – country means
# ------------------------------------------------------------
def plot_pca_country_means(df_pca_mean):
    plt.figure(figsize=(12, 8))
    plt.scatter(df_pca_mean["PC1"], df_pca_mean["PC2"], s=80)

    for i in range(len(df_pca_mean)):
        plt.text(
            df_pca_mean["PC1"].iloc[i],
            df_pca_mean["PC2"].iloc[i],
            df_pca_mean["Country"].iloc[i],
            fontsize=9
        )

    plt.xlabel("PC1")
    plt.ylabel("PC2")
    plt.title("PCA (standardized) – country means")
    plt.grid(True)
    plt.show()


# ------------------------------------------------------------
# K-Means clusters on PCA
# ------------------------------------------------------------
def plot_kmeans_pca(df_pca_mean):
    plt.figure(figsize=(12, 8))
    plt.scatter(
        df_pca_mean["PC1"],
        df_pca_mean["PC2"],
        c=df_pca_mean["cluster"],
        s=80
    )

    for i in range(len(df_pca_mean)):
        plt.text(
            df_pca_mean["PC1"].iloc[i],
            df_pca_mean["PC2"].iloc[i],
            df_pca_mean["Country"].iloc[i],
            fontsize=9
        )

    plt.xlabel("PC1")
    plt.ylabel("PC2")
    plt.title("K-Means clustering on PCA")
    plt.grid(True)
    plt.show()
